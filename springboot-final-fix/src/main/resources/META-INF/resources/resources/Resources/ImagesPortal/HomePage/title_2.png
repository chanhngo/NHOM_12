name,this.saveStatus(),i=this.getActiveDb(),f=this.getInactiveDb()));this.isFullyPopulated(i)?this.isPopulationInProgress(f)&&f.language==e?(u("[BCSPopulationManager] resuming inactive "+this.getVersion(f)+" "+f.populatedRecords+"/"+f.totalRecords),this.instrument(f,r.Resume),this.load(f)):i.version<this._config.serverBcsVersion||i.language!=e?this._config.serverBcsSupportedMarkets[e]&&!n.contains(this._config.blacklistedBcsVersions,this._config.serverBcsVersion)?(this.resetDbStatus(f),f.version=this._config.serverBcsVersion,f.source=1,f.language=e,u("[BCSPopulationManager] starting inactive "+this.getVersion(f)),this.instrument(f,r.Start),this.saveStatus(),this.load(f)):u("[BCSPopulationManager] no BCS available to upgrade"):u("[BCSPopulationManager] fully populated "+this.getVersion(i)):this.isPopulationInProgress(i)&&i.language==e?(u("[BCSPopulationManager] resuming active "+this.getVersion(i)+" "+i.populatedRecords+"/"+i.totalRecords),this.instrument(i,r.Resume),this.load(i)):e=="en-us"?(this.resetDbStatus(i),i.source=0,i.language=e,u("[BCSPopulationManager] starting active "+this.getVersion(i)),this.instrument(i,r.Start),this.saveStatus(),this.load(i)):this._config.serverBcsSupportedMarkets[e]&&!n.contains(this._config.blacklistedBcsVersions,this._config.serverBcsVersion)?(this.resetDbStatus(i),i.version=this._config.serverBcsVersion,i.source=1,i.language=e,u("[BCSPopulationManager] starting active "+this.getVersion(i)),this.instrument(i,r.Start),this.saveStatus(),this.load(i)):u("[BCSPopulationManager] no BCS available to populate")}},l.prototype.saveStatus=function(){this._lightweightStorage.setItem(s,JSON.stringify(this._status))},l.prototype.getStorage=function(n,t,i,r,u){var f=this,e=function(n){f.deleteDb(r);t(n)};if(u&&!this.isFullyPopulated(r))return t(new Error("Tried to open unpopulated db: "+r.name)),null;this._clientSideStorageFactory(r.name,n,e,i,r.schemaVersion)},l.prototype.load=function(f){var e=this;if(f.source!=1||n.isBingEnabledCache){var s=new i.BCSParser,h,o=function(){h&&h.close();e._dbBeingPopulated=null;e._loader=null},c=function(n){e.getStorage(function(t){h=t;n(t)},function(n){SharedLogHelper.LogError("open storage",f.name,n);o()},function(){e._loader&&e._loader.cancel()},f,!1)},l=function(n){if(f.populatedRecords==n){u("[BCSPopulationManager] pausing "+e.getVersion(f)+" "+f.populatedRecords+"/"+f.totalRecords);e.instrument(f,r.Pause);o();return}f.populatedRecords=n;f.totalRecords=s.getPrefixCount();f.source==0&&(f.version=s.getVersion());e.isFullyPopulated(f)?(u("[BCSPopulationManager] completed "+e.getVersion(f)),e.instrument(f,r.Complete),e._status.activeDb=f.name,e.saveStatus(),t.Promise.safeChain("cleanupFilesAsync",function(){return e._bcsDataReader.cleanupFilesAsync()}),o(),e._onDataPopulated(),sb_st(function(){return e.checkStatus()},0)):(u("[BCSPopulationManager] pausing "+e.getVersion(f)+" "+f.populatedRecords+"/"+f.totalRecords),e.instrument(f,r.Pause),e.saveStatus(),o())};this._dbBeingPopulated=f;this._loader=new i.BCSDataLoader(this.getUrl(f),this._config,this._bcsDataReader,s,f.populatedRecords,c,l)}},l.prototype.getUrl=function(t){return t.source==0?"http://BuiltInBcs":n.getWindowProtocol()+"//"+n.getWindowHost()+"/bcs/"+t.version+"/"+t.language+".js"},l.prototype.getVersion=function(n){return(n.source==0?f.LoadingFromClient:f.LoadingFromServer)+(n.version==-1?"":n.version)},l.prototype.instrument=function(n,t){t+=this._status.activeDb==n.name?r.Active:r.Inactive;this._instrumentationHelper.instrumentBcsPopulationEvent(this.getVersion(n),t)},l}();i.BCSPopulationManager=l})(i=t.Bcs||(t.Bcs={}))})(t=n.Windows||(n.Windows={}))}(AutoSuggest||(AutoSuggest={})),function(n){var t;(function(t){var i=function(){function i(n,t,i,r){this._config=n;this._host=t;this._instrumentationHelper=i;this._temporaryMessageHandler=r}return i.prototype.parse=function(i,r,u,f,e,o,s){var h=this,c;if(!f){n.isDataSourceEnabled(t.DataSources.BingContentStore,i,this._config)&&o(t.DataSources.BingContentStore,[],null);n.isDataSourceEnabled(t.DataSources.BCSApps,i,this._config)&&o(t.DataSources.BCSApps,[],null);n.isDataSourceEnabled(t.DataSources.BCSSettings,i,this._config)&&o(t.DataSources.BCSSettings,[],null);return}n.isDataSourceEnabled(t.DataSources.BingContentStore,i,this._config)&&(c={engagementSignals:f.engagementSignals,rankerExtraInfo:f.bcsVersion?{bcsVersion:f.bcsVersion}:undefined},o(t.DataSources.BingContentStore,[],c));t.lookupById(i,t.DataSources.BCSApps,t.LocalSuggestionTypes.BCSApp,f.appIds,f.appIds,function(n){return[n]},t.DataSources.BCSSettings,t.LocalSuggestionTypes.BCSSetting,f.settingIds,f.settingIds,function(n){return n},e,r,o,s,function(u,f,e,o){e.length==1&&n.safeExecute(function(){return t.parseLocalSuggestion(i,e[0],f,r,h._host,h._config,h._temporaryMessageHandler,e[0].suggestionType,h._instrumentationHelper,o,function(){return!0})},"parseLocalSuggestion "+f)},null,null,null,null,this._config,this._instrumentationHelper)},i}();t.BCSSuggestionParser=i})(t=n.Windows||(n.Windows={}))}(AutoSuggest||(AutoSuggest={}));__extends=this&&this.__extends||function(n,t){function r(){this.constructor=n}for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i]);n.prototype=t===null?Object.create(t):(r.prototype=t.prototype,new r)},function(n){var t;(function(t){var i;(function(i){var r=function(r){function u(n,f,e,o,s,h){var l,a=function(){return l.reloadStorage()},c=new i.BCSPopulationManager(n,f,SearchAppWrapper.CortanaApp.bcsDataReader,h,a,e,o,s),v=function(n,t,i){return c.getActiveBCSStorage(n,t,i)},y=function(){return c.dbPopulatedForCurrentLanguage()},p=function(n){return c.getDataSourceState(n)},w=function(n,t,i){return u.createBcsResponse(t,i,c.getActiveVersion())};return l=r.call(this,n,v,w,y,p,t.DataSources.BingContentStore,0,e)||this}return __extends(u,r),u.createBcsRes